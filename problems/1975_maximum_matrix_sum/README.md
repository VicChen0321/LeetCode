# 1975. Maximum Matrix Sum

**LeetCode Link:** [https://leetcode.com/problems/maximum-matrix-sum/](https://leetcode.com/problems/maximum-matrix-sum/)

**Difficulty:** Medium

**Tags:** Array, Greedy, Matrix

---

## 題目描述

給定一個  的整數矩陣 `matrix`。你可以執行以下操作**任意次**（包括 0 次）：

* 選擇矩陣中兩個**相鄰**（上下或左右）的元素，將它們同時乘以 `-1`。

目標是經過操作後，計算矩陣所有元素總和的**最大值**。

* 矩陣大小  可達 250，元素值範圍在  到  之間。
* 注意總和可能會超過 32-bit Integer，需使用 `long`。

### 範例

**Example 1**

* Input: `matrix = [[1,-1],[-1,1]]`
* Output: `4`
* 解釋：我們可以選擇 (0,1) 的 `-1` 和 (1,1) 的 `1` 操作，變成 `[[1,1],[-1,-1]]`，再操作其他相鄰負數，最終可以讓所有數字變成正數 `[[1,1],[1,1]]`，總和為 4。

**Example 2**

* Input: `matrix = [[1,2,3],[-1,-2,-3],[1,2,3]]`
* Output: `16`
* 解釋：負數有 3 個（-1, -2, -3）。我們可以透過操作消除兩個負號，但因為負號總數是奇數，最後一定會剩下一個負號。為了讓總和最大，我們保留絕對值最小的數字（這裡選 1）為負數。總和 = $(1+2+3+1+2+3+1+2+3) - 2 \times 1 = 16$。

---

## 解法概念

### 方法：Greedy (貪婪演算法) + 數學觀察

這題的核心不在於模擬移動過程，而在於觀察操作對「負號」的影響。

1. **負號的傳遞與抵銷**：

* 對兩個數 `(a, b)` 乘以 -1：
* 若兩個都是正數，變兩個負數（通常不這樣做）。
* 若一正一負 `(-a, b)`，變成 `(a, -b)`。這相當於把**負號從一個格子移動到了相鄰格子**。
* 若兩個都是負數 `(-a, -b)`，變成 `(a, b)`。這相當於**兩個負號互相抵銷**。

1. **關鍵 Insight**：

* 因為我們可以把負號移動到任意相鄰位置，這意味著我們可以把負號從矩陣的任何位置移動到任何其他位置（透過路徑傳遞）。
* 如果矩陣中有 **偶數個** 負數，我們可以把它們兩兩配對並相鄰抵銷，最終讓矩陣**全為正數**。
* 如果矩陣中有 **奇數個** 負數，無論怎麼操作，最後一定會**剩下一個負號**無法抵銷。

1. **策略制定**：

* 計算所有元素的**絕對值總和** (`totalSum`)。
* 統計矩陣中**負數的個數** (`negativeCount`)。
* 找出矩陣中**絕對值最小的元素** (`minAbsVal`)（無論原本是正或負）。
* **判斷**：
* 若 `negativeCount` 為 **偶數**：最大總和即為 `totalSum`（所有負號都能消除）。
* 若 `negativeCount` 為 **奇數**：我們必須犧牲一個數字讓它變負的。為了損失最小，我們選擇絕對值最小的那個數。最大總和為 `totalSum - 2 * minAbsVal`。

> 為什麼是減兩倍？因為原本 totalSum 是把它當正數加進去的，現在它變成負數，一來一往相差 $2 \times |val|$。

---

## 時間與空間複雜度

* **時間複雜度**：$O(N^2)$ 或 $O(M)$其中 $N$ 是矩陣邊長，$M$ 是元素總數。我們只需要遍歷一次矩陣即可。
* **空間複雜度**：$O(1)$只需要常數變數來儲存總和、最小值與計數。

---

### 常見錯誤陷阱

1. **回傳型別溢位**：題目矩陣總和可能很大，Java 必須使用 `long`，否則會 Wrong Answer。
2. **找最小值的範圍**：找 `minAbsVal` 時，是要找**整個矩陣**中絕對值最小的數，而不僅僅是負數中的最小。因為如果負數個數為奇數，我們可以把那個唯一的負號「轉移」給原本是正數但絕對值極小的元素（例如 0 或 1）。
3. **包含 0 的情況**：如果矩陣中有 `0`，其實視同「負數個數為偶數」的情況處理即可（或者把剩下的負號給 0，0 的負數還是 0，不影響總和），上述邏輯中的 `minAbsVal` 若為 0，減去 `2 * 0` 依然正確，邏輯通用。
